# KIP-KSM: KaspaScript‑Mini (Typed Covenant DSL) (Draft)

**Status:** Draft 0.1  
**Category:** Standards (non‑consensus)  
**Authors:** Gordon Murray (proposer)  
**Created:** 2025-10-23

## 1. Abstract
Define **KaspaScript‑Mini (KSM)**, a small, typed, policy‑first DSL that compiles to Script v2 and makes covenant contracts easy to author, analyze, and audit. KSM takes the spirit of Miniscript and ErgoScript and adapts it to Kaspa’s bounded introspection ops.

## 2. Goals
- Express common covenant patterns with **combinators** (thresholds, timelocks, same‑script, state transitions).  
- Provide a **static analyzer** that proves resource bounds and enumerates satisfaction paths.  
- Compile to compact Script v2 with no semantic surprises.

## 3. Language Sketch

### 3.1 Types
- `Bool`, `Int`, `Bytes`, `StateHash`.

### 3.2 Primitives
- `pk(pub)`  
- `after(h|t)` / `older(n)`  
- `and(a,b)`, `or(a,b)`, `thresh(k, a, b, …)`  
- **Context**:  
  `countOutputs() : Int`  
  `value(i:Int) : Int` *(outputs)*  
  `scriptHash(i:Int) : Bytes32`  
  `dataCommit(i:Int) : Bytes32` *(if enabled)*  
  `inputValue(i:Int) : Int`  
- **Covenant helpers**:  
  `sameScript(i)`  
  `withState(i, StateHash)`  
  `hash(b:Bytes) : Bytes32`  
  `checksig(msg:Bytes32, sig:Bytes, pub:Bytes33)`

### 3.3 Example: Oracle Box
```
inputs: [self(state), fee_ceiling]
witness: [price, sig]
let next = hash(price ++ state);
all(
  countOutputs() == 1,
  sameScript(0),
  withState(0, next),
  value(0) >= self.value - fee_ceiling,
  checksig(domainHash(txid || "ORACLE"), sig, ORACLE_PUB)
)
```

### 3.4 AMM Sketch
```
# reserves X,Y are encoded in state
let k    = X * Y;
let X'   = X + dx - fee(dx);
let Y'   = k / X';
require all(
  sameScript(0),
  withState(0, hash(encode(X', Y'))),
  slippage_ok(Y_to_user),
  conservation_ok()
)
```

## 4. Compiler & Analyzer
- **Compiler:** lowers KSM to Script v2 opcodes; uses template hashing (KIP‑OPCTX §3.6).  
- **Analyzer:** checks script size, stack depth, and the **max inspected outputs** bound; emits satisfaction graphs for audit.

## 5. Standard Library
Timelock/CSV combinators, multi‑sig/threshold, vault patterns, auction step, AMM math helpers, oracle aggregation.

## 6. Tooling Deliverables
- `kaspascript-mini` crate (parser, typechecker, compiler).  
- TS SDK with builders for each reference contract.  
- JSON test vectors shared across Rust/TS.

## 7. Backwards Compatibility
Non‑consensus standard. Multiple independent implementations can exist so long as they compile to equivalent Script v2 bytecode.

## 8. Open Items
- Exact grammar and encoding for state serialization (CBOR vs protobuf).  
- Deterministic rounding rules for on‑chain arithmetic helpers.
